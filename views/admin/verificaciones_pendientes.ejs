<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Verificaciones Pendientes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/stylesheets/admin_dashboard.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <header class="main-header">
        <div class="header-left">
            <a href="/logout" class="nav-link">Cerrar Sesión
                <i class="fas fa-arrow-left"></i>
            </a>
            <h2>Gestión de Verificaciones</h2>
        </div>
    </header>

    <div class="container admin-container">
        <h1>Documentos Pendientes de Revisión</h1>

        <% if (asesoresPendientes && asesoresPendientes.length > 0) { %>
            <table class="verification-table">
                <thead>
                    <tr>
                        <th>Asesor</th>
                        <th>Tipo de Verificación</th>
                        <th>Documento</th>
                        <th>Estado Actual</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <% asesoresPendientes.forEach(asesor => { %>
                        <%
                        // Identificación (KYC)
                        if (asesor.kyc_status === 'pendiente') { %>
                            <tr>
                                <td><%= asesor.nombre %> <%= asesor.apellido %></td>
                                <td>Identificación (KYC)</td>
                                <td>
                                    <% let kycUrlsFound = false; %>
                                    <% if (asesor.kyc_front_url) { kycUrlsFound = true; %>
                                        <a href="<%= asesor.kyc_front_url %>" target="_blank">Ver Documento Frontal</a><br>
                                    <% } %>
                                    <% if (asesor.kyc_back_url) { kycUrlsFound = true; %>
                                        <a href="<%= asesor.kyc_back_url %>" target="_blank">Ver Documento Trasero</a><br>
                                    <% } %>
                                    <% if (asesor.kyc_selfie_url) { kycUrlsFound = true; %>
                                        <a href="<%= asesor.kyc_selfie_url %>" target="_blank">Ver Selfie</a>
                                    <% } %>
                                    <% if (!kycUrlsFound) { %>
                                        No disponible
                                    <% } %>
                                </td>
                                <td class="status-<%= asesor.kyc_status %>"><%= asesor.kyc_status %></td>
                                <td>
                                    <button class="action-button approve-button" data-asesor-id="<%= asesor.id %>" data-type="kyc" data-action="verificar">Aprobar</button>
                                    <button class="action-button reject-button" data-asesor-id="<%= asesor.id %>" data-type="kyc" data-action="rechazar">Rechazar</button>
                                </td>
                            </tr>
                        <% } %>

                        <%
                        // Credenciales Profesionales - Título
                        if (asesor.title_status === 'pendiente') { %>
                            <tr>
                                <td><%= asesor.nombre %> <%= asesor.apellido %></td>
                                <td>Título Profesional</td>
                                <td>
                                    <% if (asesor.title_document_url) { %>
                                        <a href="<%= asesor.title_document_url %>" target="_blank">Ver Título</a>
                                    <% } else { %>
                                        No disponible
                                    <% } %>
                                </td>
                                <td class="status-<%= asesor.title_status %>"><%= asesor.title_status %></td>
                                <td>
                                    <button class="action-button approve-button" data-asesor-id="<%= asesor.id %>" data-type="titulo" data-action="verificar">Aprobar</button>
                                    <button class="action-button reject-button" data-asesor-id="<%= asesor.id %>" data-type="titulo" data-action="rechazar">Rechazar</button>
                                </td>
                            </tr>
                        <% } %>

                        <%
                        // Credenciales Profesionales - Certificación
                        if (asesor.certification_status === 'pendiente') { %>
                            <tr>
                                <td><%= asesor.nombre %> <%= asesor.apellido %></td>
                                <td>Certificación Profesional</td>
                                <td>
                                    <% if (asesor.certification_document_url) { %>
                                        <a href="<%= asesor.certification_document_url %>" target="_blank">Ver Certificación</a>
                                    <% } else { %>
                                        No disponible
                                    <% } %>
                                </td>
                                <td class="status-<%= asesor.certification_status %>"><%= asesor.certification_status %></td>
                                <td>
                                    <button class="action-button approve-button" data-asesor-id="<%= asesor.id %>" data-type="certificacion" data-action="verificar">Aprobar</button>
                                    <button class="action-button reject-button" data-asesor-id="<%= asesor.id %>" data-type="certificacion" data-action="rechazar">Rechazar</button>
                                </td>
                            </tr>
                        <% } %>
                    <% }) %>
                </tbody>
            </table>
        <% } else { %>
            <p class="no-results">No hay documentos pendientes de revisión.</p>
        <% } %>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
    const approveButtons = document.querySelectorAll('.approve-button');
    const rejectButtons = document.querySelectorAll('.reject-button'); 

    const actionButtons = document.querySelectorAll('.approve-button, .reject-button');

    actionButtons.forEach(button => {
        button.addEventListener('click', async function() {
            const asesorId = this.dataset.asesorId;
            const type = this.dataset.type;
            const action = this.dataset.action;

            let confirmationMessage = '';
            let successMessage = '';
            let errorMessage = '';

            if (action === 'verificar') {
                confirmationMessage = `¿Estás seguro de que deseas APROBAR la verificación de ${type} para el asesor ${asesorId}?`;
                successMessage = `¡Documento de ${type} aprobado con éxito!`;
                errorMessage = `Error al procesar la aprobación:`;
            } else if (action === 'rechazar') {
                confirmationMessage = `¿Estás seguro de que deseas RECHAZAR la verificación de ${type} para el asesor ${asesorId}? Se enviará un mensaje genérico al asesor.`;
                successMessage = `¡Documento de ${type} rechazado con éxito!`;
                errorMessage = `Error al procesar el rechazo:`;
            }

            if (!confirm(confirmationMessage)) {
                return;
            }

            try {
                const response = await fetch('/admin/verificar-documento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        asesorId: asesorId,
                        type: type,
                        action: action,
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(successMessage);
                    window.location.reload();
                } else {
                    alert(`${errorMessage} ${result.message || 'Error desconocido'}`);
                }
            } catch (error) {
                console.error(`Error en la solicitud de ${action}:`, error);
                alert(`Error de conexión o de red al procesar la solicitud de ${action}.`);
            }
        });
    });

});
    </script>
</body>
</html>