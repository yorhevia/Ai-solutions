<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes Asignados</title>
    <link rel="stylesheet" href="/stylesheets/home_asesor.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/stylesheets/asesor_navbar.css">
    <link rel="stylesheet" href="/stylesheets/clientes_asignados.css">
    <link rel="stylesheet" href="/stylesheets/footer.css">

</head>
<body>
    <%- include('../partials/asesor_navbar') %>
<div class="container">
    <main>
        <h1>Clientes Asignados</h1>
        <ul class="clientes-list">
            <% if (clientes.length > 0) { %>
                <% clientes.forEach(cliente => { %>
                    <li>
                        <img src="<%= cliente.fotoPerfilUrl || '/images/default-profile.png' %>" alt="Foto de <%= cliente.nombre %>" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 8px; border: 2px solid #007bff; cursor: pointer;" onclick="openModal('<%= cliente.id %>')">
                        <span onclick="openModal('<%= cliente.id %>')" style="cursor: pointer;">
                            <%= cliente.nombre %> <%= cliente.apellido %>
                        </span>
                    </li>
                <% }); %>
            <% } else { %>
                <li>No hay clientes asignados.</li>
            <% } %>
        </ul>
    </main>
</div>

    <div id="clientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalClientName"></h2>
            <img id="modalClientPhoto" src="" alt="Foto de Cliente" style="width: 100px; height: 100px; border-radius: 50%;">
            <p id="modalClientDetails"></p>
            <div id="modalClientMoreDetails">
                </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script>
        function openModal(clienteId) {
            fetch(`/api/cliente/${clienteId}`)
                .then(response => {
                    // Verificar si la respuesta es OK (status 200-299)
                    if (!response.ok) {
                        // Si no es OK, lanzar un error para que lo capture el .catch()
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Asumo que tu backend devuelve el objeto del cliente directamente si success es true
                    // O un objeto como { success: true, cliente: { ... } }
                    const clienteData = data.cliente || data; // Ajusta según lo que tu backend devuelva exactamente

                    if (clienteData && clienteData.nombre) { // Verificar si los datos del cliente son válidos
                        document.getElementById('modalClientName').innerText = `${clienteData.nombre} ${clienteData.apellido}`;
                        document.getElementById('modalClientPhoto').src = clienteData.fotoPerfilUrl || '/images/default-profile.png';
                        
                        // Crear el contenido detallado
                        const detailsContainer = document.getElementById('modalClientMoreDetails');
                        detailsContainer.innerHTML = ''; // Limpiar contenido anterior

                        detailsContainer.innerHTML += `<p><strong>Email:</strong> ${clienteData.email || 'N/A'}</p>`;
                        detailsContainer.innerHTML += `<p><strong>Teléfono:</strong> ${clienteData.telefono || 'N/A'}</p>`;
                        detailsContainer.innerHTML += `<p><strong>Dirección:</strong> ${clienteData.direccion || 'N/A'}</p>`;
                        detailsContainer.innerHTML += `<p><strong>Ahorros:</strong> $${(clienteData.ahorros || 0).toLocaleString('es-VE')}</p>`;
                        detailsContainer.innerHTML += `<p><strong>Ingresos:</strong> $${(clienteData.ingresos || 0).toLocaleString('es-VE')}</p>`;
                        detailsContainer.innerHTML += `<p><strong>Objetivo Principal:</strong> ${clienteData.objetivo_principal || 'N/A'}</p>`;
                        detailsContainer.innerHTML += `<p><strong>Perfil de Riesgo:</strong> ${clienteData.perfil_riesgo || 'N/A'}</p>`;
                        // Puedes añadir más campos aquí si los necesitas

                        // La fecha de registro que muestras es un Timestamp, necesitarás formatearla
                        if (clienteData.fechaRegistro) {
                            const date = new Date(clienteData.fechaRegistro._seconds * 1000); // Para Firebase Timestamps
                            const formattedDate = date.toLocaleDateString('es-VE', { year: 'numeric', month: 'long', day: 'numeric' });
                            detailsContainer.innerHTML += `<p><strong>Fecha de Registro:</strong> ${formattedDate}</p>`;
                        } else {
                            detailsContainer.innerHTML += `<p><strong>Fecha de Registro:</strong> N/A</p>`;
                        }


                        document.getElementById('clientModal').style.display = "block";
                        document.getElementById('modalClientDetails').style.display = "none"; // Ocultar el <p> viejo si usas el nuevo div
                    } else {
                        alert('Error: Datos de cliente incompletos o no encontrados.');
                        console.error('Datos recibidos:', data);
                    }
                })
                .catch(error => {
                    console.error('Error al obtener los datos del cliente:', error);
                    alert('Error al cargar los datos del cliente. Inténtalo de nuevo.');
                });
        }

        function closeModal() {
            document.getElementById('clientModal').style.display = "none";
        }

        // Cerrar el modal si se hace clic fuera de él
        window.onclick = function(event) {
            const modal = document.getElementById('clientModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>